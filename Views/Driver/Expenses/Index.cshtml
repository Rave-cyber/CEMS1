@{
    ViewData["Title"] = "Submit Expenses";
    Layout = "~/Views/Shared/_DriverLayout.cshtml";
}

<h2 class="mb-3">Submit Multiple Expenses</h2>
<p class="text-muted">Add multiple rows and submit them together. Receipts optional.</p>

<form id="multiExpenseForm" enctype="multipart/form-data">
    <div id="expenseRows">
        <!-- rows will be added here -->
    </div>
    <button type="button" class="btn btn-outline-primary" id="addRowBtn">Add Row</button>
    <button type="submit" class="btn btn-primary">Submit All</button>
</form>

<div id="submitResult" class="mt-3"></div>

@section Scripts {
<script>
(function(){
    const rows = document.getElementById('expenseRows');
    const addBtn = document.getElementById('addRowBtn');
    const form = document.getElementById('multiExpenseForm');

    function addRow(){
        const idx = rows.children.length;
        const div = document.createElement('div');
        div.className = 'card mb-2';
        div.innerHTML = `
            <div class="card-body row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label">Date</label>
                    <input type="date" name="items[${idx}].Date" class="form-control" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Category</label>
                    <select name="items[${idx}].Category" class="form-select">
                        <option value="Fuel">Fuel</option>
                        <option value="Toll">Toll</option>
                        <option value="Meal">Meal</option>
                        <option value="Maintenance">Maintenance</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Amount</label>
                    <input type="number" step="0.01" name="items[${idx}].Amount" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Description</label>
                    <input type="text" name="items[${idx}].Description" class="form-control" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Receipt</label>
                    <input type="file" name="items[${idx}].Receipt" class="form-control" />
                </div>
            </div>`;
        rows.appendChild(div);
    }

    addBtn.addEventListener('click', addRow);
    addRow();

    form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(form);
        const res = await fetch('/Driver/SubmitMultiple', { method:'POST', body: fd, headers: { 'X-Requested-With':'XMLHttpRequest' } });
        const data = await res.json();
        const box = document.getElementById('submitResult');
        if(data.success){
            box.innerHTML = `<div class="alert alert-success">${data.message}</div>`;
            rows.innerHTML = '';
            addRow();
        } else {
            box.innerHTML = `<div class="alert alert-danger">${(data.errors||data.message||'Failed')}</div>`;
        }
    });
})();
</script>
}























