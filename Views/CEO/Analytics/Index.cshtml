@{
    ViewData["Title"] = "Financial Reports & Analytics";
    Layout = "~/Views/Shared/_CEOLayout.cshtml";
    var budgets = ViewBag.Budgets as List<CEMS.Models.Budget> ?? new List<CEMS.Models.Budget>();
    int totalReports = ViewBag.TotalReports ?? 0;
    int approvedCount = ViewBag.ApprovedCount ?? 0;
    int rejectedCount = ViewBag.RejectedCount ?? 0;
    int pendingCount = ViewBag.PendingCount ?? 0;
    decimal monthlyReimbursed = ViewBag.MonthlyReimbursed ?? 0m;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    .chart-card {
        background: var(--d-card);
        border: 1px solid var(--d-border);
        border-radius: 10px;
        overflow: hidden;
    }

    .chart-card-head {
        background: #f8fafc;
        padding: 16px 18px;
        border-bottom: 1px solid var(--d-border);
        font-weight: 600;
        color: var(--d-text);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chart-card-body {
        padding: 20px;
    }

    .export-btn {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--d-success);
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s;
    }

    .export-btn:hover {
        background: #059669;
    }

    .table-card-head {
        background: #f8fafc;
        padding: 16px 18px;
        border-bottom: 1px solid var(--d-border);
        font-weight: 600;
        color: var(--d-text);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .empty-text {
        color: var(--d-muted);
        text-align: center;
        padding: 20px;
    }

    @@media print {
        body, html { background: #fff !important; }
        nav, header, footer, .no-print, .export-btn { display: none !important; }
        .page-wrapper { padding: 0 !important; min-height: auto !important; }
        .stat-card { break-inside: avoid; border: 1px solid #ddd !important; }
        .chart-card, .table-card { break-inside: avoid; border: 1px solid #ddd !important; }
        .container-fluid { padding: 0 !important; }
        .page-title { font-size: 1.3rem !important; }
        canvas { max-height: 250px !important; }
    }
</style>

<div class="page-wrapper">
    <div class="container-fluid px-4">
        <div class="page-header d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-bar-chart"></i>
                    Financial Reports & Analytics
                </h1>
                <p class="page-subtitle">Summarized expense and budget reports with charts and trends.</p>
            </div>
            <button onclick="window.print()" class="export-btn no-print">
                <i class="bi bi-file-earmark-pdf"></i> Export PDF
            </button>
        </div>

        <!-- Summary Cards -->
        <div class="row g-3 mb-4">
            <div class="col-xl-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--primary">
                        <i class="bi bi-file-text"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="stat-label">Total Reports</div>
                        <div class="stat-value">@totalReports</div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--success">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="stat-label">Approved</div>
                        <div class="stat-value">@approvedCount</div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--danger">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="stat-label">Rejected</div>
                        <div class="stat-value">@rejectedCount</div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--warning">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="stat-label">Pending</div>
                        <div class="stat-value">@pendingCount</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Reimbursed -->
        <div class="row g-3 mb-4">
            <div class="col-xl-3">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--info">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="stat-label">Monthly Reimbursed</div>
                        <div class="stat-value">₱@monthlyReimbursed.ToString("N0")</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="row g-3 mb-4">
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-card-head">
                        <i class="bi bi-bar-chart"></i>
                        Budget Usage by Category
                    </div>
                    <div class="chart-card-body">
                        <canvas id="budgetChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-card-head">
                        <i class="bi bi-pie-chart"></i>
                        Report Status Distribution
                    </div>
                    <div class="chart-card-body">
                        <canvas id="statusChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monthly Trend -->
        <div class="row g-3 mb-4">
            <div class="col-12">
                <div class="chart-card">
                    <div class="chart-card-head">
                        <i class="bi bi-graph-up"></i>
                        Monthly Expense Trend (Last 6 Months)
                    </div>
                    <div class="chart-card-body">
                        <canvas id="trendChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Summary Table -->
        <div class="table-card">
            <div class="table-card-head">
                <i class="bi bi-table"></i>
                Budget Summary
            </div>
            @if (budgets.Any())
            {
                <div class="table-responsive">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Allocated</th>
                                <th>Spent</th>
                                <th>Remaining</th>
                                <th>Usage</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var b in budgets)
                            {
                                var remaining = b.Allocated - b.Spent;
                                var pct = b.Allocated == 0 ? 0 : (int)Math.Round((double)(b.Spent / b.Allocated * 100));
                                var barClass = pct >= 100 ? "budget-bar-fill--danger" : pct >= 75 ? "budget-bar-fill--warn" : "budget-bar-fill--ok";
                                <tr>
                                    <td class="fw-600">@b.Category</td>
                                    <td>₱@b.Allocated.ToString("N2")</td>
                                    <td>₱@b.Spent.ToString("N2")</td>
                                    <td class="@(remaining < 0 ? "fw-bold" : "")">
                                        <span style="color: @(remaining < 0 ? "#ef4444" : "#0d8b7d");">₱@remaining.ToString("N2")</span>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="budget-bar" style="flex: 1; min-width: 80px;">
                                                <div class="budget-bar-fill @barClass" style="width:@Math.Min(pct, 100)%"></div>
                                            </div>
                                            <span style="font-weight: 600; font-size: 0.85rem;">@pct%</span>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-text">
                    <p>No budget data available.</p>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Budget usage chart
    const budgetCtx = document.getElementById('budgetChart').getContext('2d');
    new Chart(budgetCtx, {
        type: 'bar',
        data: {
            labels: [@Html.Raw(string.Join(",", budgets.Select(b => $"'{b.Category}'")))],
            datasets: [
                {
                    label: 'Allocated',
                    data: [@Html.Raw(string.Join(",", budgets.Select(b => b.Allocated.ToString("F2"))))],
                    backgroundColor: 'rgba(26, 107, 181, 0.6)',
                    borderColor: 'rgba(26, 107, 181, 1)',
                    borderWidth: 1
                },
                {
                    label: 'Spent',
                    data: [@Html.Raw(string.Join(",", budgets.Select(b => b.Spent.ToString("F2"))))],
                    backgroundColor: 'rgba(239, 68, 68, 0.6)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
    });

    // Status distribution chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Approved', 'Rejected', 'Pending'],
            datasets: [{
                data: [@approvedCount, @rejectedCount, @pendingCount],
                backgroundColor: ['rgba(16, 185, 129, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(245, 158, 11, 0.7)'],
                borderColor: '#ffffff',
                borderWidth: 2
            }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
    });

    // Monthly trend chart (loaded via API)
    async function loadTrend() {
        try {
            const res = await fetch('@Url.Action("Metrics", "CEO")');
            const data = await res.json();
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: data.monthlyData.map(m => m.label),
                    datasets: [{
                        label: 'Monthly Expenses (₱)',
                        data: data.monthlyData.map(m => m.total),
                        borderColor: 'rgba(26, 107, 181, 1)',
                        backgroundColor: 'rgba(26, 107, 181, 0.1)',
                        fill: true,
                        tension: 0.3,
                        pointBackgroundColor: 'rgba(26, 107, 181, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });
        } catch (e) { console.error('Failed to load trend data', e); }
    }
    loadTrend();
</script>
}
