@{
    ViewData["Title"] = "Expense Overview";
    Layout = "~/Views/Shared/_CEOLayout.cshtml";
    var reports = ViewBag.Reports as List<CEMS.Models.PendingExpenseReportDto> ?? new List<CEMS.Models.PendingExpenseReportDto>();
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    .summary-section {
        padding: 16px 20px;
        background: #f8fafc;
        border-top: 1px solid var(--d-border);
    }
</style>

<div class="page-wrapper">
    <div class="container-fluid px-4">
        <div class="page-header">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-receipt"></i>
                    Expense Overview
                </h1>
                <p class="page-subtitle">View all expenses across the organization.</p>
            </div>
        </div>

        <!-- Quick Filter & Date Range -->
        <div class="filter-card">
            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: space-between;">
                <div style="display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 160px;">
                        <label class="small text-muted" style="font-weight: 600; margin-bottom: 4px; display: block;">From</label>
                        <input type="date" id="expenseStart" value="@((string)ViewBag.FilterStart ?? DateTime.UtcNow.ToString("yyyy-MM-01"))" />
                    </div>
                    <div style="flex: 1; min-width: 160px;">
                        <label class="small text-muted" style="font-weight: 600; margin-bottom: 4px; display: block;">To</label>
                        <input type="date" id="expenseEnd" value="@((string)ViewBag.FilterEnd ?? DateTime.UtcNow.ToString("yyyy-MM-dd"))" />
                    </div>
                </div>
                <div style="display: flex; gap: 6px; align-items: center;">
                    <div class="quick-filter">
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-range="today">Today</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-range="week">Week</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-range="month">Month</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" data-range="year">Year</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        @if (reports.Any())
        {
            <div class="table-card">
                <div class="table-responsive">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th>Report #</th>
                                <th>Driver</th>
                                <th>Total Amount</th>
                                <th>Submitted</th>
                                <th>Status</th>
                                <th>Budget Check</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dto in reports)
                            {
                                var r = dto.Report;
                                <tr>
                                    <td><strong>#@r.Id</strong></td>
                                    <td>@(dto.UserName ?? "Unknown")</td>
                                    <td class="fw-bold">₱@r.TotalAmount.ToString("N2")</td>
                                    <td>@r.SubmissionDate.ToLocalTime().ToString("MMM d, yyyy")</td>
                                    <td>
                                        @switch (r.Status)
                                        {
                                            case CEMS.Models.ReportStatus.Approved:
                                                <span class="status-text">Approved</span>
                                                break;
                                            case CEMS.Models.ReportStatus.Rejected:
                                                <span class="status-text">Rejected</span>
                                                break;
                                            case CEMS.Models.ReportStatus.PendingCEOApproval:
                                                <span class="status-text">Pending CEO</span>
                                                break;
                                            default:
                                                <span class="status-text">Submitted</span>
                                                break;
                                        }
                                    </td>
                                    <td>
                                        <span class="status-text">
                                            @if (r.BudgetCheck == CEMS.Models.BudgetCheckStatus.OverBudget)
                                            {
                                                <span>Over Budget</span>
                                            }
                                            else
                                            {
                                                <span>Within Budget</span>
                                            }
                                        </span>
                                    </td>
                                    <td>
                                        <a class="view-btn" asp-controller="CEO" asp-action="ReportDetails" asp-route-id="@r.Id">View</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Summary -->
                <div class="summary-section">
                    <div class="row">
                        <div class="col-md-4">
                            <small style="color: var(--d-muted);">Total Amount (filtered):</small>
                            <div style="font-weight: 700; font-size: 1.1rem; color: var(--d-text);">₱@reports.Sum(r => r.Report.TotalAmount).ToString("N2")</div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <p>No expense reports found matching the selected filters.</p>
            </div>
        }
    </div>
</div>

<script>
    // auto-apply filters on this page
    document.addEventListener('DOMContentLoaded', function(){
        var start = document.getElementById('expenseStart');
        var end = document.getElementById('expenseEnd');
        function apply(){
            var s = start?.value || ''; var e = end?.value || ''; var qs = [];
            if(s) qs.push('start=' + encodeURIComponent(s)); if(e) qs.push('end=' + encodeURIComponent(e));
            var url = '@Url.Action("ExpenseOverview","CEO")' + (qs.length ? ('?' + qs.join('&')) : '');
            window.location.href = url;
        }
        [start,end].forEach(function(el){ if(el) el.addEventListener('change', function(){ if(window._debExpense) clearTimeout(window._debExpense); window._debExpense = setTimeout(apply, 200); }); });

        document.querySelectorAll('.filter-card .quick-filter [data-range]').forEach(function(btn){
            btn.addEventListener('click', function(){
                var range = btn.getAttribute('data-range'); var now = new Date(); var sdate;
                if(range==='today') sdate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                else if(range==='week') sdate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
                else if(range==='month') sdate = new Date(now.getFullYear(), now.getMonth(), 1);
                else if(range==='year') sdate = new Date(now.getFullYear(), 0, 1);
                if(start && sdate) start.value = sdate.toISOString().slice(0,10);
                if(end) end.value = now.toISOString().slice(0,10);
                setTimeout(apply, 120);
            });
        });
    });
</script>
