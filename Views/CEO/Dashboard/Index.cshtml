@{
    ViewData["Title"] = "CEO Dashboard";
    Layout = "~/Views/Shared/_CEOLayout.cshtml";

    decimal totalBudget = ViewBag.TotalBudget ?? 0m;
    decimal totalSpent = ViewBag.TotalSpent ?? 0m;
    decimal totalRemaining = ViewBag.TotalRemaining ?? 0m;
    int pendingCEOCount = ViewBag.PendingCEOCount ?? 0;
    decimal pendingCEOTotal = ViewBag.PendingCEOTotal ?? 0m;
    int activeDrivers = ViewBag.ActiveDrivers ?? 0;
    int usagePct = totalBudget == 0 ? 0 : (int)Math.Round((double)(totalSpent / totalBudget * 100));
    var recentOB = ViewBag.RecentOverBudget as List<CEMS.Models.OverBudgetReportDto> ?? new List<CEMS.Models.OverBudgetReportDto>();
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    .chart-wrap {
        height: 240px;
        position: relative;
    }
    .chart-wrap canvas {
        width: 100% !important;
        height: 100% !important;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
    }

    .chart-card {
        background: var(--d-card);
        border: 1px solid var(--d-border);
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.2s;
    }

    .chart-card:hover {
        border-color: var(--d-primary);
        box-shadow: 0 2px 8px rgba(26, 107, 181, 0.08);
    }

    .chart-card-head {
        background: linear-gradient(135deg, rgba(26, 107, 181, 0.03), rgba(16, 185, 129, 0.03));
        padding: 12px 14px;
        border-bottom: 1px solid var(--d-border);
        font-weight: 600;
        color: var(--d-text);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .chart-card-body {
        padding: 12px 14px;
    }

    .chart-card-head i {
        color: var(--d-primary);
        font-size: 1.1rem;
    }

    .table-card-head {
        background: linear-gradient(135deg, rgba(26, 107, 181, 0.03), rgba(16, 185, 129, 0.03));
        padding: 12px 14px;
        border-bottom: 1px solid var(--d-border);
        font-weight: 600;
        color: var(--d-text);
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }

    .table-card-head i {
        color: var(--d-primary);
        font-size: 1.1rem;
    }

    @@media (max-width: 768px) {
        .page-wrapper { padding: 16px 0 24px; }
        .page-title { font-size: 1.4rem; margin-bottom: 12px; }
        .charts-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }
    }
</style>

<div class="page-wrapper">
    <div class="container-fluid px-4">
        <div class="page-header" style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-building"></i>
                    CEO Dashboard
                </h1>
                <p class="page-subtitle">Welcome back, <strong>@User.Identity?.Name</strong></p>
            </div>
        </div>

        <!-- Filter Card -->
        <div class="filter-card">
            <div style="display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap; justify-content: space-between;">
                <div style="display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 160px;">
                        <label for="dashboardStart" class="form-label" style="margin-bottom: 4px;">From</label>
                        <input type="date" id="dashboardStart" value="@((string)ViewBag.FilterStart ?? DateTime.UtcNow.ToString("yyyy-MM-01"))" style="padding: 8px 10px; border: 1px solid var(--d-border); border-radius: 6px; font-size: 0.9rem;" />
                    </div>
                    <div style="flex: 1; min-width: 160px;">
                        <label for="dashboardEnd" class="form-label" style="margin-bottom: 4px;">To</label>
                        <input type="date" id="dashboardEnd" value="@((string)ViewBag.FilterEnd ?? DateTime.UtcNow.ToString("yyyy-MM-dd"))" style="padding: 8px 10px; border: 1px solid var(--d-border); border-radius: 6px; font-size: 0.9rem;" />
                    </div>
                </div>
                <div class="quick-filter">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="today" style="padding: 6px 12px; border: 1px solid var(--d-border); background: var(--d-card); color: var(--d-text); border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">Today</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="week" style="padding: 6px 12px; border: 1px solid var(--d-border); background: var(--d-card); color: var(--d-text); border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">Week</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="month" style="padding: 6px 12px; border: 1px solid var(--d-border); background: var(--d-card); color: var(--d-text); border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">Month</button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-range="year" style="padding: 6px 12px; border: 1px solid var(--d-border); background: var(--d-card); color: var(--d-text); border-radius: 6px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">Year</button>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="row g-3 mb-3">
            <div class="col-xl-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--primary">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="stat-label">Total Budget</div>
                        <div class="stat-value">₱@totalBudget.ToString("N0")</div>
                        <div class="stat-sub">All Categories</div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--success">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="stat-label">Utilized</div>
                        <div class="stat-value">₱@totalSpent.ToString("N0")</div>
                        <div class="stat-sub">@usagePct% of Budget</div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--warning">
                        <i class="bi bi-exclamation-circle"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="stat-label">Pending Review</div>
                        <div class="stat-value">₱@pendingCEOTotal.ToString("N0")</div>
                        <div class="stat-sub">@pendingCEOCount Over-Budget Request@(pendingCEOCount != 1 ? "s" : "")</div>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="stat-card">
                    <div class="stat-icon stat-icon--info">
                        <i class="bi bi-people"></i>
                    </div>
                    <div style="flex: 1;">
                        <div class="stat-label">Active Drivers</div>
                        <div class="stat-value">@activeDrivers</div>
                        <div class="stat-sub">Registered</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Budget Breakdown Pie Chart -->
            <div class="chart-card">
                <div class="chart-card-head">
                    <i class="bi bi-pie-chart"></i>
                    Budget Breakdown
                </div>
                <div class="chart-card-body">
                    <div class="chart-wrap">
                        <canvas id="ceoBudgetChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Spending Trend -->
            <div class="chart-card">
                <div class="chart-card-head">
                    <i class="bi bi-graph-up"></i>
                    Spending Trend
                </div>
                <div class="chart-card-body">
                    <div class="chart-wrap">
                        <canvas id="ceoTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Report Status Distribution -->
            <div class="chart-card">
                <div class="chart-card-head">
                    <i class="bi bi-bar-chart"></i>
                    Report Status
                </div>
                <div class="chart-card-body">
                    <div class="chart-wrap">
                        <canvas id="ceoStatusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Over-Budget Requests -->
        <div class="table-card">
            <div class="table-card-head">
                <i class="bi bi-list-check"></i>
                Recent Over-Budget Requests
            </div>
            @if (recentOB.Any())
            {
                <div class="table-responsive">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th>Report #</th>
                                <th>Driver</th>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Exceeded</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in recentOB)
                            {
                                <tr>
                                    <td><strong>#@item.Report.Id</strong></td>
                                    <td>@item.UserName</td>
                                    <td>@item.Report.SubmissionDate.ToLocalTime().ToString("MMM d, yyyy")</td>
                                    <td><strong>₱@item.Report.TotalAmount.ToString("N2")</strong></td>
                                    <td>
                                        @if (item.ExceedAmount > 0)
                                        {
                                            <span class="badge badge-danger">
                                                <i class="bi bi-exclamation-circle-fill"></i>
                                                +₱@item.ExceedAmount.ToString("N2")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="status-text">—</span>
                                        }
                                    </td>
                                    <td><span class="badge badge-warning"><i class="bi bi-clock-fill"></i> Pending CEO</span></td>
                                    <td>
                                        <a class="view-btn" asp-controller="CEO" asp-action="ReportDetails" asp-route-id="@item.Report.Id">View</a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="empty-state">
                    <i class="bi bi-check-circle"></i>
                    <p class="empty-state-title">All Clear!</p>
                    <p>No over-budget requests awaiting approval.</p>
                </div>
            }
        </div>
    </div>
</div>
                    <i class="bi bi-check-circle"></i>
                    <p>No over-budget requests pending your review.</p>
                </div>
            }
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
let trendChartInstance, statusChartInstance;

function loadDashboardCharts() {
    if(!window.Chart) return;

    const totalSpent = Number('@totalSpent.ToString(System.Globalization.CultureInfo.InvariantCulture)');
    const totalRemaining = Number('@totalRemaining.ToString(System.Globalization.CultureInfo.InvariantCulture)');
    const weeklySpending = @Html.Raw(ViewBag.WeeklySpending ?? "[]");
    const submittedCount = @(ViewBag.SubmittedCount ?? 0);
    const approvedCount = @(ViewBag.ApprovedCount ?? 0);
    const rejectedCount = @(ViewBag.RejectedCount ?? 0);
    const pendingApprovalCount = @(ViewBag.PendingApprovalCount ?? 0);

    // Budget Pie Chart
    const budgetCanvas = document.getElementById('ceoBudgetChart');
    if(budgetCanvas){
        new Chart(budgetCanvas, {
            type: 'doughnut',
            data: {
                labels: ['Spent', 'Remaining'],
                datasets: [{
                    data: [totalSpent, Math.max(0, totalRemaining)],
                    backgroundColor: ['#ef4444', '#10b981'],
                    borderColor: ['#ef4444', '#10b981'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // Spending Trend Chart (Real Data)
    const trendCanvas = document.getElementById('ceoTrendChart');
    if(trendCanvas){
        if(trendChartInstance) trendChartInstance.destroy();
        trendChartInstance = new Chart(trendCanvas, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                datasets: [{
                    label: 'Weekly Spending',
                    data: weeklySpending,
                    borderColor: '#1a6bb5',
                    backgroundColor: 'rgba(26,107,181,0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointBackgroundColor: '#1a6bb5',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Report Status Bar Chart (Real Data)
    const statusCanvas = document.getElementById('ceoStatusChart');
    if(statusCanvas){
        if(statusChartInstance) statusChartInstance.destroy();
        statusChartInstance = new Chart(statusCanvas, {
            type: 'bar',
            data: {
                labels: ['Submitted', 'Approved', 'Rejected', 'Pending CEO'],
                datasets: [{
                    label: 'Reports',
                    data: [submittedCount, approvedCount, rejectedCount, pendingApprovalCount],
                    backgroundColor: ['#f59e0b', '#10b981', '#ef4444', '#6366f1'],
                    borderColor: ['#f59e0b', '#10b981', '#ef4444', '#6366f1'],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
            }
        });
    }
}

function applyDashboardFilter() {
    const start = document.getElementById('dashboardStart')?.value;
    const end = document.getElementById('dashboardEnd')?.value;
    if(start && end) {
        window.location.href = `@Url.Action("Dashboard", "CEO")?start=${start}&end=${end}`;
    }
}

document.addEventListener('DOMContentLoaded', () => {
    loadDashboardCharts();

    // Auto-apply filter when dates change
    document.getElementById('dashboardStart')?.addEventListener('change', applyDashboardFilter);
    document.getElementById('dashboardEnd')?.addEventListener('change', applyDashboardFilter);

    // Quick-range filter buttons
    document.querySelectorAll('.quick-filter [data-range]').forEach(btn => {
        btn.addEventListener('click', function(){
            const range = this.getAttribute('data-range');
            const now = new Date();
            let start, end = now;

            if(range === 'today'){
                start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if(range === 'week'){
                const day = now.getDay();
                start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - day);
            } else if(range === 'month'){
                start = new Date(now.getFullYear(), now.getMonth(), 1);
            } else if(range === 'year'){
                start = new Date(now.getFullYear(), 0, 1);
            }

            const startStr = start.toISOString().split('T')[0];
            const endStr = end.toISOString().split('T')[0];

            window.location.href = `@Url.Action("Dashboard", "CEO")?start=${startStr}&end=${endStr}`;
        });
    });
});
</script>
</script>