@{
    ViewData["Title"] = "Manager Dashboard";
    Layout = "~/Views/Shared/_ManagerLayout.cshtml";

    decimal totalBudget = ViewBag.TotalBudget ?? 0m;
    decimal totalSpent = ViewBag.TotalSpent ?? 0m;
    decimal totalRemaining = ViewBag.TotalRemaining ?? 0m;
    int approvedTodayCount = ViewBag.ApprovedTodayCount ?? 0;
    decimal approvedTodayTotal = ViewBag.ApprovedTodayTotal ?? 0m;
    int activeDrivers = ViewBag.ActiveDrivers ?? 0;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

<style>
    :root {
        --d-primary: #1a6bb5;
        --d-accent: #2ec4b6;
        --d-bg: #f7fbfc;
        --d-card: #ffffff;
        --d-border: #e9eef6;
        --d-text: #0f1724;
        --d-muted: #6b7280;
        --d-radius: 8px;
        --d-radius-sm: 6px;
    }

    .dash-wrapper {
        background: var(--d-bg);
        min-height: calc(100vh - 80px);
        padding: 28px 0 40px;
    }

    .dash-header {
        margin-bottom: 36px;
    }
    .dash-greeting {
        font-size: 1.65rem;
        font-weight: 700;
        color: var(--d-text);
    }
    .dash-greeting span {
        color: var(--d-primary);
        font-weight: 700;
    }
    .dash-date {
        color: var(--d-muted);
        font-size: .92rem;
        margin-top: 2px;
    }

    .stat-card {
        background: var(--d-card);
        border: 1px solid var(--d-border);
        border-radius: 10px;
        padding: 18px 18px;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: transform .12s ease;
        text-decoration: none !important;
        color: inherit !important;
    }
    .stat-card:hover { transform: translateY(-2px); }

    .stat-icon {
        width: 44px;
        height: 44px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        flex-shrink: 0;
    }
    .stat-icon--pending { background: rgba(26,107,181,.06); color: #1a6bb5; }
    .stat-icon--approved { background: rgba(16,185,129,.06); color: #10b981; }
    .stat-icon--money { background: rgba(99,102,241,.06); color: #6366f1; }
    .stat-icon--warning { background: rgba(245,158,11,.06); color: #f59e0b; }
    .stat-icon--budget { background: rgba(139,92,246,.06); color: #8b5cf6; }

    .stat-label {
        font-size: .78rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: .5px;
        color: var(--d-muted);
        margin-bottom: 4px;
    }
    .stat-value {
        font-size: 1.6rem;
        font-weight: 700;
        color: var(--d-text);
        line-height: 1.2;
    }
    .stat-sub {
        font-size: .82rem;
        color: var(--d-muted);
        margin-top: 2px;
    }

    .dash-card {
        background: var(--d-card);
        border: 1px solid var(--d-border);
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    .dash-card-head {
        padding: 14px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--d-border);
    }
    .dash-card-title {
        font-size: .98rem;
        font-weight: 600;
        color: var(--d-text);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .dash-card-title i { color: var(--d-primary); font-size: 1.1rem; }
    .dash-card-body { padding: 16px 18px; }

    .budget-item {
        padding: 16px 0;
    }
    .budget-item + .budget-item {
        border-top: 1px solid var(--d-border);
    }
    .budget-label {
        font-weight: 600;
        color: var(--d-text);
        font-size: .92rem;
    }
    .budget-remain {
        font-size: .82rem;
        font-weight: 500;
    }
    .budget-remain--ok { color: #0d8b7d; }
    .budget-remain--over { color: #dc2626; }
    .budget-bar { height: 6px; border-radius: 3px; background: #f1f5f9; margin-top: 8px; overflow: hidden; }
    .budget-bar-fill { height: 100%; border-radius: 3px; transition: width .5s ease; }
    .budget-bar-fill--ok { background: var(--d-primary); }
    .budget-bar-fill--warn { background: #f59e0b; }
    .budget-bar-fill--danger { background: #ef4444; }
    .budget-amounts {
        font-size: .78rem;
        color: var(--d-muted);
        margin-top: 4px;
    }

    @@media (max-width: 768px) {
        .dash-wrapper { padding: 20px 0 32px; }
        .stat-card { padding: 20px 18px; }
    }
</style>

<div class="dash-wrapper">
    <div class="container-fluid px-4">
        <!-- Dashboard Header -->
        <div class="dash-header d-flex justify-content-between align-items-end flex-wrap gap-2">
            <div>
                <h1 class="dash-greeting">Welcome back, <span>@User.Identity?.Name</span></h1>
                <p class="dash-date mb-0">
                    <i class="bi bi-calendar3 me-1"></i>
                    @DateTime.Now.ToString("dddd, MMMM d yyyy")
                </p>
            </div>
            <a href="@Url.Action("Reports", "Manager")" class="btn px-4 py-2 text-white" style="background:var(--d-primary);border:none;border-radius:var(--d-radius-sm);font-weight:600;">
                <i class="bi bi-file-earmark-check me-1"></i> Review Reports
            </a>
        </div>

    <script>
        async function loadManagerMetrics(){
            try{
                const res = await fetch('@Url.Action("Metrics","Manager")');
                const data = await res.json();
                document.getElementById('mgrPendingCount').textContent = data.totalPending ?? 0;
                document.getElementById('mgrOverBudget').textContent = data.overBudgetCount ?? 0;
                document.getElementById('mgrApproved').textContent = '₱' + ((data.approved ?? 0).toFixed ? data.approved.toFixed(2) : Number(data.approved).toFixed(2));

                const container = document.getElementById('budgetOverview');
                if(container && data.budgets){
                    container.innerHTML = '';
                    for(const b of data.budgets){
                        const percent = b.allocated === 0 ? 0 : Math.min(100, Math.round((b.spent / b.allocated) * 100));
                        const fillClass = percent >= 100 ? 'budget-bar-fill--danger' : percent >= 75 ? 'budget-bar-fill--warn' : 'budget-bar-fill--ok';
                        const div = document.createElement('div');
                        div.className = 'budget-item';
                        div.innerHTML = `
                            <div class="d-flex justify-content-between">
                                <div class="budget-label">${b.category}</div>
                                <div class="budget-remain ${percent >= 100 ? 'budget-remain--over' : 'budget-remain--ok'}">₱${b.spent.toFixed(2)} / ₱${b.allocated.toFixed(2)}</div>
                            </div>
                            <div class="budget-bar">
                                <div class="budget-bar-fill ${fillClass}" style="width:${percent}%"></div>
                            </div>
                            <div class="budget-amounts">${percent}% used</div>
                        `;
                        container.appendChild(div);
                    }
                }
            }catch(e){ console.error(e); }
        }

        document.addEventListener('DOMContentLoaded', loadManagerMetrics);
    </script>

        <!-- Stats Row -->
        <div class="row g-3 mb-4">
            <div class="col-xl-3 col-sm-6">
                <a href="@Url.Action("Reports", "Manager")" class="stat-card">
                    <div class="stat-icon stat-icon--pending">
                        <i class="bi bi-hourglass-split"></i>
                    </div>
                    <div>
                        <div class="stat-label">Pending Review</div>
                        <div class="stat-value"><span id="mgrPendingCount">—</span></div>
                        <div class="stat-sub">Expense requests</div>
                    </div>
                </a>
            </div>
            <div class="col-xl-3 col-sm-6">
                <a href="@Url.Action("Reports", "Manager")" class="stat-card">
                    <div class="stat-icon stat-icon--approved">
                        <i class="bi bi-check2-circle"></i>
                    </div>
                    <div>
                        <div class="stat-label">Approved Today</div>
                        <div class="stat-value">₱<span id="approvedValue">@approvedTodayTotal.ToString("0.00")</span></div>
                        <div class="stat-sub">@approvedTodayCount expenses</div>
                    </div>
                </a>
            </div>
            <div class="col-xl-3 col-sm-6">
                <a href="@Url.Action("OverBudget", "Manager")" class="stat-card">
                    <div class="stat-icon stat-icon--warning">
                        <i class="bi bi-exclamation-triangle"></i>
                    </div>
                    <div>
                        <div class="stat-label">Over Budget</div>
                        <div class="stat-value"><span id="mgrOverBudget">0</span></div>
                        <div class="stat-sub">Reports flagged</div>
                    </div>
                </a>
            </div>
            <div class="col-xl-3 col-sm-6">
                <a href="@Url.Action("Budget", "Manager")" class="stat-card">
                    <div class="stat-icon stat-icon--budget">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <div>
                        <div class="stat-label">Team Budget</div>
                        <div class="stat-value">₱<span id="totalBudgetVal">@totalBudget.ToString("0.00")</span></div>
                        <div class="stat-sub">@Math.Round((totalSpent / (totalBudget > 0 ? totalBudget : 1)) * 100)% utilized</div>
                    </div>
                </a>
            </div>
        </div>

            <!-- Budget Overview Section -->
            <div class="row g-3 mb-4">
                <div class="col-lg-8">
                    <div class="dash-card">
                        <div class="dash-card-head">
                            <div class="dash-card-title">
                                <i class="bi bi-graph-up"></i> Current Budget Usage
                            </div>
                        </div>
                        <div class="dash-card-body">
                            <div id="budgetOverview">
                                <p class="text-muted text-center py-4">Loading budget data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="dash-card">
                        <div class="dash-card-head">
                            <div class="dash-card-title">
                                <i class="bi bi-calculator"></i> Budget Summary
                            </div>
                        </div>
                        <div class="dash-card-body">
                            <div class="budget-item">
                                <div class="budget-label">Total Budget</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: var(--d-text); margin-top: 4px;">₱@totalBudget.ToString("N2")</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-label">Total Spent</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: var(--d-text); margin-top: 4px;">₱@totalSpent.ToString("N2")</div>
                            </div>
                            <div class="budget-item">
                                <div class="budget-label">Remaining</div>
                                <div style="font-size: 1.4rem; font-weight: 700; color: @(totalRemaining < 0 ? "#dc2626" : "#0d8b7d"); margin-top: 4px;">₱@totalRemaining.ToString("N2")</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dash-card">
                <div class="dash-card-head">
                    <div class="dash-card-title">
                        <i class="bi bi-lightning"></i> Quick Actions
                    </div>
                </div>
                <div class="dash-card-body">
                    <div class="row g-2">
                        <div class="col-md-3">
                            <a href="@Url.Action("Reports", "Manager")" class="btn btn-outline-primary w-100">
                                <i class="bi bi-file-earmark-check me-2"></i> Review Reports
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="@Url.Action("OverBudget", "Manager")" class="btn btn-outline-warning w-100">
                                <i class="bi bi-exclamation-triangle me-2"></i> Over-Budget
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="@Url.Action("Budget", "Manager")" class="btn btn-outline-primary w-100">
                                <i class="bi bi-graph-up me-2"></i> Budget Details
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="@Url.Action("Reports", "Manager")" class="btn btn-outline-primary w-100">
                                <i class="bi bi-people me-2"></i> Team Overview
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<style>
    .role-pill{
        display:inline-block;
        background: linear-gradient(135deg,#1a6bb5 0%,#2ec4b6 100%);
        color:#fff;
        padding:6px 12px;
        border-radius:999px;
        font-weight:600;
        box-shadow:0 6px 18px rgba(26,107,181,0.18);
    }

    .stat-card{ border-radius:12px; border:none; padding:0;}
    .stat-card .card-body{ padding:1.25rem 1.5rem; }
    .stat-card .stat-line{ width:64px; height:64px; border-radius:12px; background:linear-gradient(135deg,#1a6bb5 0%,#2ec4b6 100%); box-shadow: 0 8px 24px rgba(46,196,182,0.12); }
    .stat-card h6{ letter-spacing:0.04em; font-size:0.75rem; }
    .stat-card h3{ font-size:1.6rem; }
    .stat-card p{ margin-bottom:0; }

    .hover-shadow:hover {
        transform: translateY(-2px);
        transition: all 0.3s ease;
    }

    .table thead th{ border-bottom: none; background: transparent; color:#546877; }
    .table tbody tr:hover{ background:#fbfcff; }
    .table td, .table th{ vertical-align:middle; }
    .badge { border-radius: 8px; padding: 0.35rem 0.6rem; font-weight:600; }
</style>