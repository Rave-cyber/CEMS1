@{
    ViewData["Title"] = "Super Admin Dashboard";
    Layout = "~/Views/Shared/_SuperAdminLayout.cshtml";

    var totalUsers = (int)ViewBag.TotalUsers;
    var totalRoles = (int)ViewBag.TotalRoles;
    var roleCounts = (Dictionary<string, int>)ViewBag.RoleCounts;
    var recentLogs = (List<CEMS.Models.AuditLog>)ViewBag.RecentLogs;
    var logUsers = (Dictionary<string, string?>)ViewBag.LogUsers;
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
    :root {
        --d-primary: #1a6bb5;
        --d-accent: #2ec4b6;
        --d-bg: #f7fbfc;
        --d-card: #ffffff;
        --d-border: #e9eef6;
        --d-text: #0f1724;
        --d-muted: #6b7280;
        --d-radius: 8px;
        --d-radius-lg: 10px;
    }

    .page-wrapper {
        background: var(--d-bg);
        min-height: calc(100vh - 80px);
        padding: 28px 0 40px;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .greeting-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--d-text);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .greeting-subtitle {
        color: var(--d-muted);
        font-size: 0.95rem;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
        margin-bottom: 28px;
    }

    .stat-card {
        background: var(--d-card);
        border: 1px solid var(--d-border);
        border-radius: var(--d-radius-lg);
        padding: 20px;
        display: flex;
        align-items: flex-start;
        gap: 16px;
        transition: all 0.2s;
        text-decoration: none;
        color: inherit;
    }

    .stat-card:hover {
        border-color: var(--d-primary);
        box-shadow: 0 4px 12px rgba(26, 107, 181, 0.08);
    }
    .stat-card { cursor: pointer; }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: var(--d-radius-lg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .stat-icon--primary { background: rgba(26, 107, 181, 0.1); color: var(--d-primary); }
    .stat-icon--success { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .stat-icon--warning { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .stat-icon--info { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }

    .stat-label {
        color: var(--d-muted);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--d-text);
        line-height: 1.2;
    }

    .stat-sub {
        color: var(--d-muted);
        font-size: 0.85rem;
        margin-top: 4px;
    }

    .action-section {
        margin-bottom: 32px;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--d-text);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 16px;
    }

    .action-card {
        background: var(--d-card);
        border: 1px solid var(--d-border);
        border-radius: var(--d-radius-lg);
        padding: 20px;
        text-align: center;
        transition: all 0.2s;
        text-decoration: none;
        color: inherit;
        cursor: pointer;
    }

    .action-card:hover {
        border-color: var(--d-primary);
        box-shadow: 0 4px 12px rgba(26, 107, 181, 0.08);
        transform: translateY(-2px);
    }

    .action-icon {
        width: 64px;
        height: 64px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        margin: 0 auto 12px;
    }

    .action-icon--users { background: rgba(26, 107, 181, 0.1); color: var(--d-primary); }
    .action-icon--roles { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .action-icon--logs { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .action-icon--reports { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }

    .action-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--d-text);
        margin-bottom: 8px;
    }

    .action-desc {
        color: var(--d-muted);
        font-size: 0.8rem;
    }

    .role-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        margin-bottom: 28px;
    }

    .role-card {
        background: var(--d-card);
        border: 1px solid var(--d-border);
        border-radius: var(--d-radius-lg);
        padding: 16px;
        text-align: center;
        transition: all 0.2s;
    }

    .role-card:hover {
        border-color: var(--d-primary);
        box-shadow: 0 2px 8px rgba(26, 107, 181, 0.08);
    }

    .role-count {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--d-primary);
        margin-bottom: 4px;
    }

    .role-name {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--d-text);
    }

    .table-card {
        background: var(--d-card);
        border: 1px solid var(--d-border);
        border-radius: var(--d-radius-lg);
        overflow: hidden;
    }

    .table-card-head {
        background: #f8fafc;
        padding: 16px 18px;
        border-bottom: 1px solid var(--d-border);
        font-weight: 600;
        color: var(--d-text);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
    }

    .table-card-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
    }

    .table-card-title i {
        color: var(--d-primary);
        font-size: 1rem;
    }

    .dash-table {
        width: 100%;
        margin-bottom: 0;
    }

    .dash-table thead th {
        background: #f8fafc;
        color: var(--d-muted);
        font-weight: 600;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 12px 16px;
        border: none;
    }

    .dash-table tbody td {
        padding: 14px 16px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: middle;
        color: var(--d-text);
        font-size: 0.9rem;
    }

    .dash-table tbody tr:last-child td {
        border-bottom: none;
    }

    .dash-table tbody tr:hover {
        background: #f8fafc;
    }

    .action-btn {
        font-size: 0.85rem;
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid var(--d-border);
        background: var(--d-card);
        color: var(--d-primary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .action-btn:hover {
        background: var(--d-primary);
        color: #fff;
        border-color: var(--d-primary);
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
    }

    .empty-state i {
        font-size: 2.5rem;
        color: var(--d-border);
        margin-bottom: 12px;
    }

    .empty-state p {
        color: var(--d-muted);
        margin: 0;
    }

    .badge-action {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .badge-action--primary { background: rgba(26, 107, 181, 0.1); color: var(--d-primary); }

    /* Chart Container */
    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 28px;
    }

    .chart-card {
        background: var(--d-card);
        border: 1px solid var(--d-border);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .chart-card-title {
        font-weight: 600;
        color: var(--d-text);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chart-card-title i {
        color: var(--d-primary);
    }

    canvas { max-height: 240px !important; }

    @@media (max-width: 768px) {
        .page-wrapper { padding: 20px 0 32px; }
        .greeting-title { font-size: 1.4rem; }
        .metrics-grid { grid-template-columns: 1fr; }
        .stat-card { gap: 12px; padding: 16px; }
        .stat-value { font-size: 1.3rem; }
        .action-grid { grid-template-columns: repeat(2, 1fr); }
        .role-grid { grid-template-columns: repeat(2, 1fr); }
        .chart-grid { grid-template-columns: 1fr; }
    }
</style>

<div class="page-wrapper">
    <div class="container-fluid px-4">
        <!-- Header -->
        <div class="page-header">
            <h1 class="greeting-title">
                <i class="bi bi-shield-lock"></i>
                Super Admin Dashboard
            </h1>
            <p class="greeting-subtitle">Welcome back, <strong>@User.Identity?.Name</strong></p>
            <div class="mb-3">
                <span class="badge bg-info text-dark">UPDATED VIEW</span>
            </div>
        </div>

<script>
    // Ensure cards are clickable even if layout CSS interferes.
    (function(){
        // For anchors, ensure clicks on inner elements navigate
        document.querySelectorAll('.stat-card, .action-card').forEach(function(card){
            // If it's an anchor already, nothing else needed; make sure it fills area
            if(card.tagName.toLowerCase() === 'a'){
                card.style.display = card.style.display || 'flex';
                card.style.width = '100%';
                return;
            }

            // If it's not an anchor but has data-href, navigate on click
            var href = card.getAttribute('data-href') || card.getAttribute('href');
            if(href){
                card.addEventListener('click', function(e){
                    // Ignore clicks on buttons/inputs inside the card
                    if(e.target && (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('button'))){
                        return;
                    }
                    window.location = href;
                });
                card.style.cursor = 'pointer';
            }
        });
    })();
</script>
        <!-- Audit Logs Filter -->
        <div class="filter-card" style="margin-bottom: 20px;">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label class="form-label">From Date</label>
                    <input type="date" id="filterStart" class="form-control form-control-sm" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">To Date</label>
                    <input type="date" id="filterEnd" class="form-control form-control-sm" />
                </div>
                <div class="col-md-6 d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnToday">Today</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnWeek">Week</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnMonth">Month</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnYear">Year</button>
                </div>
            </div>
        </div>

        <!-- Key Metrics -->
        <div class="metrics-grid">
            <a href="@Url.Action("Users","SuperAdmin")" class="stat-card" aria-label="View users">
                <div class="stat-icon stat-icon--primary">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div style="flex: 1;">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value">@totalUsers</div>
                    <div class="stat-sub">System Users</div>
                </div>
            </a>

            <a href="@Url.Action("Users","SuperAdmin")" class="stat-card" aria-label="View roles">
                <div class="stat-icon stat-icon--success">
                    <i class="bi bi-person-badge"></i>
                </div>
                <div style="flex: 1;">
                    <div class="stat-label">Total Roles</div>
                    <div class="stat-value">@totalRoles</div>
                    <div class="stat-sub">Active Roles</div>
                </div>
            </a>

            <a href="@Url.Action("AuditLogs","SuperAdmin")" class="stat-card" aria-label="View audit logs">
                <div class="stat-icon stat-icon--warning">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div style="flex: 1;">
                    <div class="stat-label">Recent Actions</div>
                    <div class="stat-value">@recentLogs.Count</div>
                    <div class="stat-sub">Audit Logs</div>
                </div>
            </a>
        </div>

        <!-- Quick Actions -->
        <div class="action-section">
            <h3 class="section-title">
                <i class="bi bi-lightning"></i> Quick Actions
            </h3>
            <div class="action-grid">
                <a href="@Url.Action("Index", "SuperAdmin", new { area = "" })?page=users" class="action-card">
                    <div class="action-icon action-icon--users">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="action-title">Manage Users</div>
                    <div class="action-desc">Add, edit or remove users</div>
                </a>

                <a href="@Url.Action("AuditLogs", "SuperAdmin", new { area = "" })" class="action-card">
                    <div class="action-icon action-icon--logs">
                        <i class="bi bi-file-earmark-text"></i>
                    </div>
                    <div class="action-title">Audit Logs</div>
                    <div class="action-desc">View system activities</div>
                </a>

                <a href="javascript:void(0)" class="action-card" onclick="alert('Role management coming soon!')">
                    <div class="action-icon action-icon--roles">
                        <i class="bi bi-person-badge"></i>
                    </div>
                    <div class="action-title">Manage Roles</div>
                    <div class="action-desc">Configure user roles</div>
                </a>

                <a href="javascript:void(0)" class="action-card" onclick="alert('System reports coming soon!')">
                    <div class="action-icon action-icon--reports">
                        <i class="bi bi-graph-up"></i>
                    </div>
                    <div class="action-title">System Reports</div>
                    <div class="action-desc">View analytics</div>
                </a>
            </div>
        </div>

        <!-- Role Distribution -->
        <div class="action-section">
            <h3 class="section-title">
                <i class="bi bi-diagram-3"></i> Role Distribution
            </h3>
            <div class="role-grid">
                @foreach (var rc in roleCounts)
                {
                    <div class="role-card">
                        <div class="role-count">@rc.Value</div>
                        <div class="role-name">@rc.Key</div>
                    </div>
                }
                 </div>
            </div>

            <!-- Analytics Charts -->
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-card-title">
                        <i class="bi bi-pie-chart"></i>
                        Role Distribution Chart
                    </div>
                    <canvas id="roleChart"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-card-title">
                        <i class="bi bi-bar-chart"></i>
                        Activity by Action Type
                    </div>
                    <canvas id="activityChart"></canvas>
                    </div>
                </div>

                <!-- Recent Audit Logs -->
                <div class="table-card">
            <div class="table-card-head">
                <div class="table-card-title">
                    <i class="bi bi-activity"></i>
                    Recent Activity
                </div>
                <a asp-action="AuditLogs" class="action-btn">
                    <i class="bi bi-arrow-right"></i> View All
                </a>
            </div>
            @if (recentLogs.Count == 0)
            {
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>No audit logs yet.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="dash-table">
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Performed By</th>
                                <th>Details</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in recentLogs)
                            {
                                <tr>
                                    <td>
                                        <span style="color: #0f1724; font-weight: 600;">@log.Action</span>
                                    </td>
                                    <td>
                                        @if (log.PerformedByUserId != null && logUsers.ContainsKey(log.PerformedByUserId))
                                        {
                                            @logUsers[log.PerformedByUserId]
                                        }
                                        else
                                        {
                                            <span class="text-muted">System</span>
                                        }
                                    </td>
                                    <td>@log.Details</td>
                                    <td>@log.Timestamp.ToString("MMM dd, yyyy hh:mm tt")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<script>
    // Load and render charts
    function initCharts() {
        // Role Distribution Chart
        var roleLabels = [@string.Join(",", roleCounts.Keys.Select(k => $"'{k}'"))];
        var roleData = [@string.Join(",", roleCounts.Values)];

        var roleCtx = document.getElementById('roleChart');
        if (roleCtx && roleLabels.length > 0) {
            new Chart(roleCtx, {
                type: 'doughnut',
                data: {
                    labels: roleLabels,
                    datasets: [{
                        data: roleData,
                        backgroundColor: [
                            'rgba(26, 107, 181, 0.8)',   // Primary blue
                            'rgba(16, 185, 129, 0.8)',   // Success green
                            'rgba(245, 158, 11, 0.8)',   // Warning orange
                            'rgba(59, 130, 246, 0.8)',   // Info light blue
                            'rgba(139, 92, 246, 0.8)',   // Purple
                            'rgba(107, 114, 128, 0.8)'   // Gray
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                boxWidth: 12,
                                font: { size: 12 },
                                padding: 12,
                                color: '#0f1724'
                            }
                        }
                    }
                }
            });
        }

        // Activity by Action Type
        var actionCounts = {};
        var logs = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(recentLogs));
        logs.forEach(function(log) {
            actionCounts[log.action] = (actionCounts[log.action] || 0) + 1;
        });

        var actionLabels = Object.keys(actionCounts).slice(0, 8);
        var actionData = actionLabels.map(function(label) { return actionCounts[label]; });

        var activityCtx = document.getElementById('activityChart');
        if (activityCtx && actionLabels.length > 0) {
            new Chart(activityCtx, {
                type: 'bar',
                data: {
                    labels: actionLabels,
                    datasets: [{
                        label: 'Actions Count',
                        data: actionData,
                        backgroundColor: 'rgba(26, 107, 181, 0.6)',
                        borderColor: 'rgba(26, 107, 181, 1)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { color: '#6b7280', font: { size: 11 } }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#6b7280', font: { size: 11 } }
                        }
                    }
                }
            });
        }
    }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            initQuickRangeButtons();
        });

        function initQuickRangeButtons() {
            var startInput = document.getElementById('filterStart');
            var endInput = document.getElementById('filterEnd');

            function setDateRange(start, end) {
                startInput.value = start;
                endInput.value = end;
                applyFilter();
            }

            function applyFilter() {
                var start = startInput.value;
                var end = endInput.value;
                if (start && end) {
                    window.location = '@Url.Action("Dashboard", "SuperAdmin")' + '?start=' + start + '&end=' + end;
                }
            }

            // Today
            document.getElementById('btnToday').addEventListener('click', function() {
                var today = new Date().toISOString().split('T')[0];
                setDateRange(today, today);
            });

            // Week
            document.getElementById('btnWeek').addEventListener('click', function() {
                var today = new Date();
                var weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
                var weekEnd = new Date(today.setDate(today.getDate() + 6));
                setDateRange(weekStart.toISOString().split('T')[0], weekEnd.toISOString().split('T')[0]);
            });

            // Month
            document.getElementById('btnMonth').addEventListener('click', function() {
                var today = new Date();
                var monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                var monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                setDateRange(monthStart.toISOString().split('T')[0], monthEnd.toISOString().split('T')[0]);
            });

            // Year
            document.getElementById('btnYear').addEventListener('click', function() {
                var today = new Date();
                var yearStart = new Date(today.getFullYear(), 0, 1);
                var yearEnd = new Date(today.getFullYear(), 11, 31);
                setDateRange(yearStart.toISOString().split('T')[0], yearEnd.toISOString().split('T')[0]);
            });

            // Auto-filter on date change
            startInput.addEventListener('change', applyFilter);
            endInput.addEventListener('change', applyFilter);
        }
    </script>
